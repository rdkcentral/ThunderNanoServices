autostart = "@PLUGIN_COMPOSITOR_AUTOSTART@"

configuration = JSON()

memory_settings = JSON()
if boolean("@PLUGIN_COMPOSITOR_NXSERVER@"):
    if "@PLUGIN_COMPOSITOR_MEMORY_GFX@":
        memory_settings.add("gfx", "@PLUGIN_COMPOSITOR_MEMORY_GFX@")

    if "@PLUGIN_COMPOSITOR_MEMORY_GFX2@":
        memory_settings.add("gfx2", "@PLUGIN_COMPOSITOR_MEMORY_GFX2@")

    if "@PLUGIN_COMPOSITOR_MEMORY_RESTRICTED@":
        memory_settings.add("restricted", "@PLUGIN_COMPOSITOR_MEMORY_RESTRICTED@")

    if "@PLUGIN_COMPOSITOR_MEMORY_MAIN@":
        memory_settings.add("main", "@PLUGIN_COMPOSITOR_MEMORY_MAIN@")

    if "@PLUGIN_COMPOSITOR_MEMORY_EXPORT@":
        memory_settings.add("export", "@PLUGIN_COMPOSITOR_MEMORY_EXPORT@")

    if "@PLUGIN_COMPOSITOR_MEMORY_SECURE_GFX@":
        memory_settings.add("secureGFX", "@PLUGIN_COMPOSITOR_MEMORY_SECURE_GFX@")

    if "@PLUGIN_COMPOSITOR_MEMORY_CLIENT@":
        memory_settings.add("client", "@PLUGIN_COMPOSITOR_MEMORY_CLIENT@")

rootconfig = JSON()
rootconfig.add("mode", "@PLUGIN_COMPOSITOR_MODE@")
rootconfig.add("locator", "@PLUGIN_COMPOSITOR_IMPLEMENTATION_LIB@")
if "@PLUGIN_COMPOSITOR_IMPLEMENTATION@" == "RPI":
    if "@PLUGIN_COMPOSITOR_MODE@" == "Local":
        rootconfig.add("threads", "@PLUGIN_COMPOSITOR_THREAD_COUNT@")

configuration.add("resolution", "@PLUGIN_COMPOSITOR_RESOLUTION@")

if "@PLUGIN_COMPOSITOR_IMPLEMENTATION@" == "Wayland":
    if "@PLUGIN_COMPOSITOR_SUB_IMPLEMENTATION@" == "Westeros":
        configuration.add("display", "wayland-0")
        configuration.add("renderer", "/usr/lib/libwesteros_render_gl.so")
        configuration.add("glname", "libwesteros_gl.so.0.0.0")
        configuration.add("workdir", "/tmp/wayland")
        configuration.add("cursor", "@PLUGIN_COMPOSITOR_CURSOR_FILE@")

if boolean("@PLUGIN_COMPOSITOR_NXSERVER@"):

    if boolean("@PLUGIN_COMPOSITOR_ALLOW_UNAUTHENTICATED_CLIENTS@"):
        configuration.add("authentication", "true")

    if "@PLUGIN_COMPOSITOR_IRMODE@":
        configuration.add("irmode", "@PLUGIN_COMPOSITOR_IRMODE@")

    if "@PLUGIN_COMPOSITOR_BOXMODE@":
        configuration.add("boxmode", "@PLUGIN_COMPOSITOR_BOXMODE@")

    if "@PLUGIN_COMPOSITOR_AUTHENTICATION@":
        configuration.add("authentication", "@PLUGIN_COMPOSITOR_AUTHENTICATION@")

    if "@PLUGIN_COMPOSITOR_SVP@":
        configuration.add("svp", "@PLUGIN_COMPOSITOR_SVP@")

    if "@PLUGIN_COMPOSITOR_FRAMEBUFFER_WIDTH@":
        configuration.add("framebufferwidth", "@PLUGIN_COMPOSITOR_FRAMEBUFFER_WIDTH@")

    if "@PLUGIN_COMPOSITOR_FRAMEBUFFER_HEIGHT@":
        configuration.add("framebufferheight", "@PLUGIN_COMPOSITOR_FRAMEBUFFER_HEIGHT@")

    if "@PLUGIN_COMPOSITOR_SAGE_PATH@":
        configuration.add("sagepath", "@PLUGIN_COMPOSITOR_SAGE_PATH@")

    if "@PLUGIN_COMPOSITOR_PAK_PATH@":
        configuration.add("pakpath", "@PLUGIN_COMPOSITOR_PAK_PATH@")

    if "@PLUGIN_COMPOSITOR_DRM_PATH@":
        configuration.add("drmpath", "@PLUGIN_COMPOSITOR_DRM_PATH@")

    if "@PLUGIN_COMPOSITOR_HDCP_LEVEL@":
        configuration.add("hdcplevel", "@PLUGIN_COMPOSITOR_HDCP_LEVEL@")

    if "@PLUGIN_COMPOSITOR_HDCP_VERSION@":
        configuration.add("hdcpversion", "@PLUGIN_COMPOSITOR_HDCP_VERSION@")

    if "@PLUGIN_COMPOSITOR_HDCP1XBIN_PATH@":
        configuration.add("hdcp1xbinfile", "@PLUGIN_COMPOSITOR_HDCP1XBIN_PATH@")

    if "@PLUGIN_COMPOSITOR_HDCP2XBIN_PATH@":
        configuration.add("hdcp2xbinfile", "@PLUGIN_COMPOSITOR_HDCP2XBIN_PATH@")

    if "@PLUGIN_COMPOSITOR_LOUDNESS_MODE@":
        configuration.add("loudnessmode", "@PLUGIN_COMPOSITOR_LOUDNESS_MODE@")

if "@PLUGIN_COMPOSITOR_IMPLEMENTATION@" == "Nexus":

    if int("@PLUGIN_COMPOSITOR_HARDWAREREADY@") > 0:
        configuration.add("hardwareready", "@PLUGIN_COMPOSITOR_HARDWAREREADY@")

    if boolean("@PLUGIN_COMPOSITOR_FAIL_SAFE_HDR@"):
        configuration.add("failsafehdr", "true")

if "@PLUGIN_COMPOSITOR_IMPLEMENTATION@" == "Nexus":
    if "@PLUGIN_COMPOSITOR_ALLOWED_CLIENTS@":
        configuration.add("allowedclients", "@PLUGIN_COMPOSITOR_ALLOWED_CLIENTS@".split(';'))
    configuration.add("memory", memory_settings)

if "@PLUGIN_COMPOSITOR_IMPLEMENTATION@" == "Wayland":
    if "@PLUGIN_COMPOSITOR_SUB_IMPLEMENTATION@" == "Weston":
        if "@PLUGIN_COMPOSITOR_WESTON_TTY_LIST@":
            configuration.add("tty", "@PLUGIN_COMPOSITOR_WESTON_TTY_LIST@".split(';'))

        if "@PLUGIN_COMPOSITOR_WESTON_OUTPUT_CONFIGS@":
            output_configs_list = []
            for output_config in "@PLUGIN_COMPOSITOR_WESTON_OUTPUT_CONFIGS@".split(';'):
                output_config_items = output_config.split(',')
                if len(output_config_items) == 3:
                    output_config_dict = {}
                    output_config_dict['name'] = output_config_items[0]
                    output_config_dict['mode'] = output_config_items[1]
                    output_config_dict['transform'] = output_config_items[2]
                    output_configs_list.append(output_config_dict)
            configuration.add("outputs", output_configs_list)

configuration.add("root", rootconfig)
